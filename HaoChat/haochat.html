---
layout: simple
title: "HaoChat"
permalink: /haochat/
---

<div class="haochat-page">
  <h1 class="haochat-title">HaoChat</h1>
  {% assign haochat_space = site.haochat_space_id | default: "YuexingHao/HaoChat" | strip %}
  {% if haochat_space contains "http" %}
    {% assign haochat_space_url = haochat_space %}
  {% else %}
    {% assign haochat_space_url = haochat_space | prepend: "https://huggingface.co/spaces/" %}
  {% endif %}
  <p class="haochat-intro">Ask me anything about Yuexing Hao. Powered by <a href="{{ haochat_space_url }}" target="_blank" rel="noopener">HaoChat Space</a> on Hugging Face.</p>

  <div id="haochat-messages" class="haochat-messages"></div>

  <div class="haochat-input-wrap">
    <textarea id="haochat-input" class="haochat-input" rows="2" placeholder="Ask a question about Yuexing..." maxlength="2000"></textarea>
    <button type="button" id="haochat-send" class="haochat-send" aria-label="Send">
      <i class="fa fa-paper-plane"></i> Send
    </button>
    <button type="button" id="haochat-reset" class="haochat-reset" aria-label="Clear chat">Reset</button>
  </div>
  <p id="haochat-limit-msg" class="haochat-limit-msg" style="display: none;">Maximum 10 turns. Clear chat to continue.</p>

  <p class="haochat-disclaimer">Replies are generated by an AI model and may not be fully accurate. Conversations are private and not saved.</p>
  <!-- <p class="haochat-disclaimer">If replies mention LinkedIn or critique a profile, the <a href="{{ haochat_space_url }}" target="_blank" rel="noopener">Hugging Face Space</a> is misconfigured (wrong parameter order). See <a href="https://github.com/YuexingHao/Yuexing-Hao/blob/main/HaoChat/HAOCHAT_SPACE.md">HAOCHAT_SPACE.md</a> to fix.</p> -->
</div>

<style>
.haochat-page {
  max-width: 720px;
  margin: 0 auto;
  padding: 20px 0 60px;
}
.haochat-title {
  margin: 20px 0 8px;
  color: #000;
}
body.dark-mode .haochat-title {
  color: #fff;
}
.haochat-intro {
  color: #000;
  margin: 0 0 24px;
  font-size: 15px;
}
.haochat-intro a { color: #000; text-decoration: underline; }
body.dark-mode .haochat-intro a { color: #fff; }
.haochat-messages {
  min-height: 200px;
  margin-bottom: 20px;
  padding: 16px;
  background: #fff;
  border: 1px solid #000;
  border-radius: 12px;
}
body.dark-mode .haochat-messages {
  background: #000;
  border-color: #fff;
}
.haochat-msg {
  margin-bottom: 16px;
  padding: 12px 14px;
  border-radius: 10px;
  line-height: 1.5;
  white-space: pre-wrap;
  word-break: break-word;
}
.haochat-msg.user {
  background: #fff;
  border: 1px solid #000;
  margin-left: 0;
  margin-right: 24px;
}
body.dark-mode .haochat-msg.user {
  background: #000;
  border-color: #fff;
}
.haochat-msg.assistant {
  background: #fff;
  border: 1px solid #000;
  margin-left: 24px;
  margin-right: 0;
}
body.dark-mode .haochat-msg.assistant {
  background: #000;
  border-color: #fff;
}
.haochat-msg .label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 6px;
  color: #000;
}
body.dark-mode .haochat-msg .label {
  color: #fff;
}
.haochat-input-wrap {
  display: flex;
  gap: 12px;
  align-items: flex-end;
  margin-bottom: 12px;
}
.haochat-input {
  flex: 1;
  padding: 12px 14px;
  font-size: 15px;
  font-family: inherit;
  border: 1px solid #000;
  border-radius: 10px;
  resize: none;
  min-height: 48px;
  max-height: 120px;
  background: #fff;
  color: #000;
}
.haochat-input:focus {
  outline: none;
  border-color: #000;
  box-shadow: 0 0 0 2px #000;
}
body.dark-mode .haochat-input {
  background: #000;
  border-color: #fff;
  color: #fff;
}
body.dark-mode .haochat-input:focus {
  border-color: #fff;
  box-shadow: 0 0 0 2px #fff;
}
.haochat-send {
  padding: 12px 20px;
  font-size: 15px;
  font-weight: 500;
  color: #fff;
  background: #000;
  border: 1px solid #000;
  border-radius: 10px;
  cursor: pointer;
  white-space: nowrap;
}
.haochat-send:hover {
  background: #fff;
  color: #000;
}
.haochat-send:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
body.dark-mode .haochat-send {
  color: #000;
  background: #fff;
  border-color: #fff;
}
body.dark-mode .haochat-send:hover {
  background: #000;
  color: #fff;
}
.haochat-send .fa { margin-right: 6px; }
.haochat-reset {
  padding: 12px 16px;
  font-size: 14px;
  color: #000;
  background: #fff;
  border: 1px solid #000;
  border-radius: 10px;
  cursor: pointer;
  white-space: nowrap;
}
.haochat-reset:hover {
  background: #f0f0f0;
}
body.dark-mode .haochat-reset {
  color: #fff;
  background: #000;
  border-color: #fff;
}
body.dark-mode .haochat-reset:hover {
  background: #333;
}
.haochat-limit-msg {
  font-size: 13px;
  color: #666;
  margin: -8px 0 12px;
}
body.dark-mode .haochat-limit-msg { color: #aaa; }
.haochat-disclaimer {
  font-size: 12px;
  color: #000;
  margin: 0;
}
body.dark-mode .haochat-disclaimer { color: #fff; }
.haochat-typing {
  color: #000;
  font-style: italic;
}
body.dark-mode .haochat-typing { color: #fff; }
</style>

<script>
(function() {
  var SPACE_ID = '{{ site.haochat_space_id | default: "" }}'.trim();
  var USE_SPACE = SPACE_ID.length > 0;

  var MAX_TURNS = 10;
  var messagesEl = document.getElementById('haochat-messages');
  var inputEl = document.getElementById('haochat-input');
  var sendBtn = document.getElementById('haochat-send');
  var resetBtn = document.getElementById('haochat-reset');
  var limitMsgEl = document.getElementById('haochat-limit-msg');
  var gradioApp = null;
  var ClientPromise = null;

  function getTurnCount() {
    return messagesEl.querySelectorAll('.haochat-msg.user').length;
  }

  function updateLimitUI() {
    var atLimit = getTurnCount() >= MAX_TURNS;
    sendBtn.disabled = atLimit;
    if (limitMsgEl) limitMsgEl.style.display = atLimit ? 'block' : 'none';
  }

  function resetChat() {
    messagesEl.innerHTML = '';
    sendBtn.disabled = false;
    if (limitMsgEl) limitMsgEl.style.display = 'none';
    inputEl.placeholder = 'Ask a question about Yuexing...';
  }

  function getClientFromModule(m) {
    if (!m) return null;
    if (m.Client && typeof m.Client.connect === 'function') return m.Client;
    if (m.default) {
      if (m.default.Client && typeof m.default.Client.connect === 'function') return m.default.Client;
      if (typeof m.default.connect === 'function') return m.default;
    }
    return null;
  }

  function loadGradioClient() {
    if (ClientPromise) return ClientPromise;
    var urls = [
      'https://esm.sh/@gradio/client@1.4.2',
      'https://cdn.jsdelivr.net/npm/@gradio/client@1.4.2/+esm',
      'https://cdn.jsdelivr.net/npm/@gradio/client@1.4.2/dist/index.min.js'
    ];
    function tryNext(i) {
      if (i >= urls.length) return Promise.reject(new Error('Gradio client could not be loaded. Try the Space directly: https://huggingface.co/spaces/' + SPACE_ID));
      return import(urls[i]).then(function(m) {
        var C = getClientFromModule(m);
        if (C) return C;
        return tryNext(i + 1);
      }, function() { return tryNext(i + 1); });
    }
    ClientPromise = tryNext(0);
    return ClientPromise;
  }

  function addMessage(role, text, isTyping) {
    var div = document.createElement('div');
    div.className = 'haochat-msg ' + role;
    var label = role === 'user' ? 'You' : 'HaoChat';
    div.innerHTML = '<div class="label">' + label + '</div>' + (isTyping ? '<span class="haochat-typing">' + escapeHtml(text) + '</span>' : escapeHtml(text));
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return div;
  }

  function escapeHtml(s) {
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  function setMessageContent(assistantDiv, text) {
    var label = assistantDiv.querySelector('.label');
    if (label.nextSibling) label.nextSibling.remove();
    var content = document.createElement('div');
    content.style.whiteSpace = 'pre-wrap';
    content.style.wordBreak = 'break-word';
    content.textContent = text || '';
    label.after(content);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function updateStreamingContent(assistantDiv, text) {
    var label = assistantDiv.querySelector('.label');
    var content = label.nextElementSibling;
    if (!content) {
      content = document.createElement('div');
      content.style.whiteSpace = 'pre-wrap';
      content.style.wordBreak = 'break-word';
      label.after(content);
    }
    content.textContent = text || '';
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function showError(assistantDiv, msg) {
    assistantDiv.querySelector('.label').nextSibling.remove();
    var content = document.createElement('div');
    content.style.color = 'inherit';
    content.textContent = msg;
    assistantDiv.querySelector('.label').after(content);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  sendBtn.addEventListener('click', function() { send(); });
  if (resetBtn) resetBtn.addEventListener('click', resetChat);
  inputEl.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  function getReplyFromResult(result) {
    if (typeof result === 'string') return result;
    if (result && Array.isArray(result) && result.length > 0) {
      var last = result[result.length - 1];
      if (typeof last === 'string') return last;
      if (last && typeof last === 'object' && Array.isArray(last)) return (last[1] || last[0] || '').toString();
      return last.toString();
    }
    if (result && result.data && Array.isArray(result.data)) return (result.data[0] || '').toString();
    if (result && result.output != null) return String(result.output);
    return '';
  }

  function spaceBaseUrl() {
    if (SPACE_ID.indexOf('http') === 0) return SPACE_ID.replace(/\/$/, '');
    var parts = SPACE_ID.split('/').filter(Boolean);
    if (parts.length >= 2) return 'https://' + parts[0].toLowerCase() + '-' + parts[1].toLowerCase().replace(/_/g, '-') + '.hf.space';
    return '';
  }

  function getConversationHistory() {
    var history = [];
    var msgs = messagesEl.querySelectorAll('.haochat-msg');
    for (var i = 0; i < msgs.length; i++) {
      var msg = msgs[i];
      var role = msg.classList.contains('user') ? 'user' : (msg.classList.contains('assistant') ? 'assistant' : null);
      if (!role) continue;
      var label = msg.querySelector('.label');
      var contentEl = label ? label.nextElementSibling : msg;
      var text = (contentEl && contentEl.textContent) ? contentEl.textContent.trim() : '';
      if (text && text !== 'Thinking...') history.push({ role: role, content: text });
    }
    return history;
  }

  /** Convert [{role, content}, ...] to [[user, assistant], ...] for Gradio Space compatibility. */
  function historyToGradioPairs(history) {
    var pairs = [];
    for (var i = 0; i < history.length; i++) {
      var h = history[i];
      if (h.role === 'user') pairs.push([h.content, '']);
      else if (h.role === 'assistant' && pairs.length) pairs[pairs.length - 1][1] = h.content;
    }
    return pairs;
  }

  function extractReplyFromData(data) {
    if (!data || !Array.isArray(data) || data.length === 0) return '';
    var first = data[0];
    if (typeof first === 'string') return first;
    if (first && first.content) return String(first.content);
    return '';
  }

  function callSpaceWithFetch(text, systemMessage, history, assistantDiv) {
    var base = spaceBaseUrl();
    if (!base) return Promise.reject(new Error('Invalid haochat_space_id'));
    var historyPairs = historyToGradioPairs(history || []);
    var payload = { data: [text, historyPairs, systemMessage, 512, 0.7, 0.95] };
    var apiPath = '/gradio_api/call/chat';
    return fetch(base + apiPath, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
      .then(function(r) {
        if (!r.ok) throw new Error('Space returned ' + r.status);
        return r.json();
      })
      .then(function(json) {
        var eventId = json && json.event_id;
        if (!eventId) throw new Error('No event_id from Space');
        return fetch(base + apiPath + '/' + eventId, { headers: { Accept: 'text/event-stream' } });
      })
      .then(function(res) {
        if (!res.ok) throw new Error('Space result failed');
        if (!res.body) return Promise.reject(new Error('Stream not supported'));
        var reader = res.body.getReader();
        var decoder = new TextDecoder();
        var buffer = '';
        var lastReply = '';
        function readChunk() {
          return reader.read().then(function(result) {
            if (result.done) return lastReply;
            buffer += decoder.decode(result.value, { stream: true });
            var lines = buffer.split('\n');
            buffer = lines.pop() || '';
            for (var i = 0; i < lines.length; i++) {
              if (lines[i].indexOf('data:') === 0) {
                try {
                  var data = JSON.parse(lines[i].slice(5).trim());
                  if (data && Array.isArray(data)) {
                    lastReply = extractReplyFromData(data);
                    updateStreamingContent(assistantDiv, lastReply);
                  }
                } catch (_) {}
              }
            }
            return readChunk();
          });
        }
        return readChunk();
      });
  }

  // Keep in sync with Space DEFAULT_SYSTEM (HaoChat/HAOCHAT_SPACE.md).
  var SYSTEM_MSG = 'You are Yuexing Hao. Reply in first person as Yuexing. GREETINGS RULE: If the user says hi, hey, hello, or similar, reply with ONLY a short greeting (e.g. "Hey! How are you doing? What can I help with?")—do NOT list, enumerate, or repeat anything from the bio below. For real questions, answer only what was asked in 1–3 short sentences. Never copy, paraphrase, or enumerate the bio. Never mention LinkedIn or profile critique. If unsure, point to yuexinghao.github.io.\n\nAbout you (Yuexing Hao):\n- You are a Postdoctoral Associate at MIT EECS in the Healthy ML Group, hosted by Prof. Marzyeh Ghassemi.\n- You received your Ph.D. from Cornell University (2022–25) and were an IvyPlus Exchange Scholar at MIT (2024–25).\n- Internships: Google Research (2025), Scale AI (2025), Mayo Clinic (2024).\n- Education: B.A. in Computer Science from Rutgers University (2017–20), M.S. from Tufts University (2020–22).\n- You are based in Boston, MA. In your spare time you enjoy ice hockey, squash, and water skiing.\n- Your name means "happy walking is good"; pronunciation is "You-Sing."\n- You founded Hug Medical (AI for medication management) in 2022 (hugmed.ai).\n\nResearch focus: LLM agents, RLHF, AI alignment; AI for healthcare and human–computer interaction.\n\nSelected publications (first-authored): Nature Digital Medicine (MedEduChat, systematic review on LLMs in cancer), CHI (wayfinding/health conversations, patient-centered shared decision-making, in-basket/LLM comparison), CSCW, AAAI (veterinary precision health), Bioinformatics, IntelliSys; preprints on MedPAIR, MedGUIDE, MedPerturb, GPU equity, RtE. Venues: CHI, NPJ Digital Medicine, CSCW, AAAI, MCP Digital Health.\n\nSelected awards/grants: PCCW Frank H.T. Rhodes Leadership & Mission Grant, APF K. Anders Ericsson Dissertation Research Grant, Life Science Technology Innovation Fellowship, ACM SIGCHI Gary Marsden Travel Award, NCWIT Collegiate Award, IEEE ComSoc Student Competition, ICM, Tufts Graduate Student Research Competition, and others (see yuexinghao.github.io).\n\nService: FAccT registration committee, CSCW/CHI associate chair.\n\nLinks: Google Scholar, GitHub (YuexingHao), LinkedIn, Twitter; CV and full site at yuexinghao.github.io.';

  function send() {
    var text = (inputEl.value || '').trim();
    if (!text) return;
    if (getTurnCount() >= MAX_TURNS) return;
    inputEl.value = '';
    var history = getConversationHistory();
    addMessage('user', text);
    sendBtn.disabled = true;
    var assistantDiv = addMessage('assistant', 'Thinking...', true);

    if (USE_SPACE) {
      (function runSpace() {

        function useFetchFallback() {
          return callSpaceWithFetch(text, SYSTEM_MSG, history, assistantDiv).then(function(reply) {
            if (reply) updateStreamingContent(assistantDiv, reply);
            else updateStreamingContent(assistantDiv, 'No response.');
          });
        }

        var historyPairs = historyToGradioPairs(history);
        var chatPayload = { message: text, history: historyPairs, system_message: SYSTEM_MSG, max_tokens: 512, temperature: 0.7, top_p: 0.95 };

        var promise = gradioApp
          ? Promise.resolve(gradioApp)
          : loadGradioClient()
              .then(function(Client) {
                if (!Client || typeof Client.connect !== 'function') throw new Error('client failed');
                return Client.connect(SPACE_ID, {
                  status_callback: function(status) {
                    if (status && status.status === 'building') setMessageContent(assistantDiv, 'Space is building...');
                    else if (status && status.status === 'sleeping') setMessageContent(assistantDiv, 'Waking up the Space...');
                  }
                });
              })
              .then(function(app) {
                gradioApp = app;
                return app;
              })
              .catch(function(err) {
                return useFetchFallback();
              });

        promise
          .then(function(appOrUndefined) {
            if (!appOrUndefined) return undefined;
            if (typeof appOrUndefined.submit !== 'function') {
              if (typeof appOrUndefined.predict === 'function') {
                return appOrUndefined.predict('/chat', chatPayload);
              }
              return undefined;
            }
            var sub = appOrUndefined.submit('/chat', chatPayload);
            return new Promise(function(resolve, reject) {
              (function consume() {
                sub.next().then(function(iter) {
                  if (iter.done) { resolve(iter.value && iter.value.data ? getReplyFromResult(iter.value.data) : undefined); return; }
                  var msg = iter.value;
                  if (msg && msg.type === 'data' && msg.data !== undefined) updateStreamingContent(assistantDiv, getReplyFromResult(msg.data));
                  consume();
                }).catch(reject);
              })();
            });
          })
          .then(function(result) {
            if (result !== undefined) {
              var reply = getReplyFromResult(result);
              if (reply) updateStreamingContent(assistantDiv, reply);
            }
          })
          .catch(function(err) {
            showError(assistantDiv, err.message || 'Could not reach the HaoChat Space. Try directly: https://huggingface.co/spaces/' + SPACE_ID);
          })
          .then(function() {
            updateLimitUI();
          });
      })();
      return;
    }

    var API_BASE = '{{ site.haochat_api_url | default: "" }}' || '';
    var API_URL = API_BASE ? (API_BASE.replace(/\/$/, '') + '/api/chat') : '/api/chat';
    fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    })
      .then(function(res) {
        return res.text().then(function(raw) {
          var data = {};
          try { data = JSON.parse(raw); } catch (_) {}
          if (!res.ok) {
            var msg = data.reply || data.error;
            if (res.status === 404) msg = msg || 'API not found (404). Set haochat_space_id in _config.yml to use your Hugging Face Space.';
            else if (res.status === 500) msg = msg || 'Server error (500).';
            else msg = msg || 'Server returned ' + res.status + '.';
            throw new Error(msg);
          }
          return data;
        });
      })
      .then(function(data) {
        setMessageContent(assistantDiv, data.reply || data.error || 'No response.');
      })
      .catch(function(err) {
        showError(assistantDiv, err.message || 'Chat unavailable. Set haochat_space_id in _config.yml to your Space (e.g. YuexingHao/HaoChat).');
      })
      .then(function() {
        updateLimitUI();
      });
  }
})();
</script>
